- name: Install Nextcloud on Ubuntu 24.04
  hosts: nextcloud
  become: true
  vars_files:
    - .env

  tasks:
    - name: Install required packages
      apt:
        name: 
          - mariadb-server
          - apache2
          - php
          - php-mysql
          - php-gd
          - php-curl
          - php-mbstring
          - php-xml
          - php-zip
          - php-intl
          - unzip
        state: present
        update_cache: yes

    - name: Partition and format disk
      block:
        - name: Check if disk is already mounted
          command: "mountpoint -q {{ NEXTCLOUD_DATA_DIR }}"
          register: mount_check
          failed_when: false
          changed_when: false

        - name: Partition and format disk
          filesystem:
            fstype: ext4
            dev: "{{ DISK_DEVICE }}"
            force: yes
          when: mount_check.rc != 0

        - name: Create mount point
          file:
            path: "{{ NEXTCLOUD_DATA_DIR }}"
            state: directory
          when: mount_check.rc != 0

        - name: Mount disk
          mount:
            path: "{{ NEXTCLOUD_DATA_DIR }}"
            src: "{{ DISK_DEVICE }}"
            fstype: ext4
            opts: defaults
            state: mounted
          when: mount_check.rc != 0

    - name: Ensure proper permissions on data directory
      file:
        path: "{{ NEXTCLOUD_DATA_DIR }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0770'

    - name: Secure MySQL installation
      mysql_secure_installation:
        login_password: "{{ MYSQL_ROOT_PASS }}"
        root_password: "{{ MYSQL_ROOT_PASS }}"
        user_remove_anonymous: true
        user_allow_remote_root: false
        disallow_root_login: true
        remove_test_db: true

    - name: Create Nextcloud database
      mysql_db:
        name: "{{ NEXTCLOUD_DB_NAME }}"
        state: present
        login_user: root
        login_password: "{{ MYSQL_ROOT_PASS }}"

    - name: Create Nextcloud database user
      mysql_user:
        name: "{{ NEXTCLOUD_DB_USER }}"
        password: "{{ NEXTCLOUD_DB_PASS }}"
        priv: "{{ NEXTCLOUD_DB_NAME }}.*:ALL"
        host: "{{ NEXTCLOUD_DB_HOST }}"
        state: present
        login_user: root
        login_password: "{{ MYSQL_ROOT_PASS }}"

    - name: Set MySQL to listen on all interfaces
      lineinfile:
        path: /etc/mysql/mariadb.conf.d/50-server.cnf
        regexp: '^bind-address'
        line: 'bind-address = 0.0.0.0'
        state: present
      notify: Restart MySQL

    - name: Restart MySQL
      service:
        name: mariadb
        state: restarted

    - name: Download Nextcloud
      get_url:
        url: https://download.nextcloud.com/server/releases/latest.zip
        dest: /tmp/nextcloud.zip

    - name: Extract Nextcloud
      unarchive:
        src: /tmp/nextcloud.zip
        dest: /var/www/html
        remote_src: yes

    - name: Set permissions for Nextcloud
      file:
        path: /var/www/html/nextcloud
        state: directory
        owner: www-data
        group: www-data
        recurse: yes

    - name: Configure Nextcloud config.php
      template:
        src: nextcloud.config.php.j2
        dest: /var/www/html/nextcloud/config/config.php
        owner: www-data
        group: www-data
        mode: '0640'

    - name: Deploy Apache Virtual Host configuration for Nextcloud
      template:
        src: apache.conf.j2
        dest: /etc/apache2/sites-available/nextcloud.conf
      notify: Restart Apache

    - name: Enable Nextcloud site
      command: a2ensite nextcloud.conf
      notify: Restart Apache

    - name: Disable default Apache site
      command: a2dissite 000-default.conf
      notify: Restart Apache

  handlers:
    - name: Restart Apache
      service:
        name: apache2
        state: restarted
