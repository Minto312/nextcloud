- name: Install Nextcloud on Ubuntu 24.04
  hosts: nextcloud
  become: true
  vars_files:
    - .env

  tasks:
    - name: Install required packages
      apt:
        name: 
          - mariadb-server
          - apache2
          - php
          - php-mysql
          - php-gd
          - php-curl
          - php-mbstring
          - php-xml
          - php-zip
          - php-intl
          - unzip
        state: present
        update_cache: yes

    - name: Partition and format disk
      block:
        - name: Check if disk is already mounted
          command: "mountpoint -q {{ NEXTCLOUD_DATA_DIR }}"
          register: mount_check
          failed_when: false
          changed_when: false

        - name: Partition and format disk
          filesystem:
            fstype: ext4
            dev: "{{ DISK_DEVICE }}"
            force: yes
          when: mount_check.rc != 0

        - name: Create mount point
          file:
            path: "{{ NEXTCLOUD_DATA_DIR }}"
            state: directory
          when: mount_check.rc != 0

        - name: Mount disk
          mount:
            path: "{{ NEXTCLOUD_DATA_DIR }}"
            src: "{{ DISK_DEVICE }}"
            fstype: ext4
            opts: defaults
            state: mounted
          when: mount_check.rc != 0

    - name: Ensure proper permissions on data directory
      file:
        path: "{{ NEXTCLOUD_DATA_DIR }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0770'

    - name: Download Nextcloud
      get_url:
        url: https://download.nextcloud.com/server/releases/latest.zip
        dest: /tmp/nextcloud.zip

    - name: Extract Nextcloud
      unarchive:
        src: /tmp/nextcloud.zip
        dest: /var/www/html
        remote_src: yes

    - name: Set permissions for Nextcloud
      file:
        path: /var/www/html/nextcloud
        state: directory
        owner: www-data
        group: www-data
        recurse: yes

    - name: Configure Nextcloud data directory
      copy:
        dest: /var/www/html/nextcloud/config/config.php
        content: |
          <?php
          $CONFIG = array (
            'datadirectory' => '{{ NEXTCLOUD_DATA_DIR }}',
            'dbtype' => 'mysql',
            'dbname' => '{{ NEXTCLOUD_DB_NAME }}',
            'dbhost' => '{{ NEXTCLOUD_DB_HOST }}',
            'dbuser' => '{{ NEXTCLOUD_DB_USER }}',
            'dbpassword' => '{{ NEXTCLOUD_DB_PASS }}',
            'installed' => false,
          );

    - name: Restart Apache
      service:
        name: apache2
        state: restarted
